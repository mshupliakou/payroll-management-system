<div th:fragment="scriptsFragment">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/1.4.1/css/rowGroup.dataTables.min.css">
    <script src="https://cdn.datatables.net/rowgroup/1.4.1/js/dataTables.rowGroup.min.js"></script>

    <script src="/js/dashboard.js"></script>

    <style>
        .group-pagination {
            display: flex; justify-content: space-between; align-items: center;
            margin: 10px 0; background: #f8f9fa; padding: 10px;
            border-radius: 4px; border: 1px solid #ddd; gap: 10px;
        }
        .group-btn {
            padding: 5px 15px; cursor: pointer; background-color: #27ae60;
            color: white; border: none; border-radius: 4px; font-weight: bold;
        }
        .group-btn:hover { background-color: #219150; }
        .group-btn.secondary { background-color: #6c757d; }
        .group-btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        .group-info { font-weight: bold; font-size: 1.1em; flex-grow: 1; text-align: center; }
        div.dataTables_wrapper { width: 100%; }
        .dt-buttons { margin-bottom: 15px; }
    </style>

    <script th:inline="none">
        $(document).ready(function() {
            console.log("--- START SKRYPTU ---");

            // WAŻNE: Czyścimy stare filtry DataTables, żeby się nie dublowały przy przeładowaniu fragmentów
            $.fn.dataTable.ext.search = [];

            // --- KONFIGURACJA WSPÓLNA ---
            const commonSettings = {
                "dom": 'Bfrtip',
                "buttons": [
                    { extend: 'excelHtml5', className: 'btn', exportOptions: { columns: ':not(:last-child)' } },
                    { extend: 'print', className: 'btn', exportOptions: { columns: ':not(:last-child)' } }
                ],
                "language": {
                    "processing": "Przetwarzanie...", "search": "Szukaj:", "lengthMenu": "Pokaż _MENU_ pozycji",
                    "info": "Pozycje od _START_ do _END_ z _TOTAL_ łącznie", "infoEmpty": "Brak danych",
                    "infoFiltered": "(filtrowanie z _MAX_)", "loadingRecords": "Wczytywanie...",
                    "zeroRecords": "Brak danych", "paginate": { "first": "<<", "previous": "<", "next": ">", "last": ">>" },
                    "emptyTable": "Brak danych"
                },
                "columnDefs": [ { "orderable": false, "targets": -1 } ]
            };

            function getSettings(placeholder) {
                let s = $.extend(true, {}, commonSettings);
                s.language.search = placeholder;
                return s;
            }

            // ============================================================
            // 1. TABELA PRACOWNIKA (My Work Hours)
            // ============================================================
            if ($('#myWorkHoursTable').length > 0) {
                (function() {
                    let tableId = 'myWorkHoursTable';
                    let settings = getSettings("Szukaj w historii:");
                    settings.paging = false;
                    settings.dom = 'Bfrt';
                    settings.columnDefs = [
                        { "visible": false, "targets": 0 }, // Kolumna Grupy (0) ukryta
                        { "orderable": false, "targets": -1 }
                    ];
                    settings.order = [[1, 'desc']];

                    settings.rowGroup = {
                        dataSrc: 0,
                        startRender: function (rows, group) {
                            return $('<tr/>').append('<td colspan="10" style="background-color: #e0e0e0; font-weight: bold;">' +
                                'Tydzień: ' + group + ' (' + rows.count() + ' wpisów)' +
                                '</td>');
                        }
                    };

                    let table = $('#' + tableId).DataTable(settings);

                    let rawData = table.column(0).data().toArray();
                    let uniqueGroups = [];
                    $.each(rawData, function(i, val){
                        let textVal = val ? String(val).replace(/<[^>]+>/g, '').trim() : "";
                        if(textVal && $.inArray(textVal, uniqueGroups) === -1) uniqueGroups.push(textVal);
                    });

                    if(uniqueGroups.length > 0) {
                        let currentIndex = 0;
                        let showAll = false;
                        let navHtml = `
                            <div class="group-pagination">
                                <button id="btn-prev-my" class="group-btn" type="button">&laquo; Starsze</button>
                                <span id="display-my" class="group-info">Ładowanie...</span>
                                <button id="btn-next-my" class="group-btn" type="button">Nowsze &raquo;</button>
                                <button id="btn-all-my" class="group-btn secondary" type="button">Pokaż wszystko</button>
                            </div>`;
                        $('#' + tableId + '_wrapper').prepend(navHtml);

                        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                            if (settings.nTable.id !== tableId) return true;
                            if (showAll) return true;
                            let rowVal = data[0] ? String(data[0]).replace(/<[^>]+>/g, '').trim() : "";
                            return rowVal === uniqueGroups[currentIndex];
                        });

                        function updateView() {
                            if (showAll) {
                                $('#display-my').text("Wszystkie tygodnie (" + uniqueGroups.length + ")");
                                $('#btn-prev-my, #btn-next-my').prop('disabled', true);
                                $('#btn-all-my').text("Pokaż jeden tydzień");
                            } else {
                                $('#display-my').text(uniqueGroups[currentIndex]);
                                $('#btn-prev-my').prop('disabled', currentIndex >= uniqueGroups.length - 1);
                                $('#btn-next-my').prop('disabled', currentIndex <= 0);
                                $('#btn-all-my').text("Pokaż wszystko");
                            }
                            table.draw();
                        }

                        $(document).on('click', '#btn-all-my', function() { showAll = !showAll; updateView(); });
                        $(document).on('click', '#btn-prev-my', function() { if (!showAll && currentIndex < uniqueGroups.length - 1) { currentIndex++; updateView(); } });
                        $(document).on('click', '#btn-next-my', function() { if (!showAll && currentIndex > 0) { currentIndex--; updateView(); } });
                        updateView();
                    }
                })();
            }

            // ============================================================
            // 2. TABELA DO WYPŁATY (PayoutsTable)
            // ============================================================
            if ($('#PayoutsTable').length > 0) {
                try {
                    let payoutsSettings = getSettings("Szukaj wypłaty:");
                    payoutsSettings.paging = false;
                    payoutsSettings.dom = 'Bfrt';
                    // Kol 0: Checkbox, Kol 1: Miesiąc (ukryty), Kol 8 (ostatnia): Akcje
                    payoutsSettings.columnDefs = [
                        { "orderable": false, "targets": 0 },
                        { "visible": false, "targets": 1 },
                        { "orderable": false, "targets": -1 }
                    ];
                    payoutsSettings.order = [[4, 'desc']]; // Data

                    payoutsSettings.rowGroup = {
                        dataSrc: 1,
                        startRender: function (rows, group) {
                            return $('<tr/>').append('<td colspan="9" style="background-color: #e0e0e0; font-weight: bold; cursor: pointer;" class="group-header-row">' +
                                '<input type="checkbox" class="group-checkbox" style="margin-right: 10px;">' +
                                'Miesiąc: ' + group + ' (' + rows.count() + ' pozycji)' +
                                '</td>');
                        }
                    };

                    let payoutsTable = $('#PayoutsTable').DataTable(payoutsSettings);

                    function updateBulkActions() {
                        let selectedIds = [];
                        $('.payout-checkbox:checked').each(function() { selectedIds.push($(this).val()); });
                        $('#selectedCount').text(selectedIds.length);
                        if (selectedIds.length > 0) $('#bulkActionsBar').css('display', 'flex'); else $('#bulkActionsBar').hide();

                        let statusHtml = '', deleteHtml = '';
                        selectedIds.forEach(function(id) {
                            statusHtml += '<input type="hidden" name="ids" value="' + id + '">';
                            deleteHtml += '<input type="hidden" name="ids" value="' + id + '">';
                        });
                        $('#bulkStatusInputs').html(statusHtml);
                        $('#bulkDeleteInputs').html(deleteHtml);
                    }

                    $(document).on('change', '.payout-checkbox', updateBulkActions);
                    $('#selectAllCheckbox').on('click', function() {
                        let isChecked = $(this).is(':checked');
                        $('.payout-checkbox, .group-checkbox').prop('checked', isChecked);
                        updateBulkActions();
                    });
                    $(document).on('click', '.group-checkbox', function(e) {
                        e.stopPropagation();
                        let isChecked = $(this).is(':checked');
                        let groupRow = $(this).closest('tr');
                        let nextRows = groupRow.nextUntil('tr.dtrg-group');
                        nextRows.find('.payout-checkbox').prop('checked', isChecked);
                        updateBulkActions();
                    });
                } catch(e) { console.error("Błąd PayoutsTable:", e); }
            }

            // ============================================================
            // 3. TABELA RAPORTU (salaryOverviewTable)
            // ============================================================
            if ($('#salaryOverviewTable').length > 0) {
                try {
                    let salaryTable = $('#salaryOverviewTable').DataTable({
                        dom: 'Bfrtip',
                        buttons: [ { extend: 'excelHtml5', className: 'btn' }, { extend: 'print', className: 'btn' } ],
                        paging: false,
                        order: [[0, 'asc']], // Domyślnie po dziale
                        rowGroup: {
                            dataSrc: 0,
                            startRender: function (rows, group) {
                                // Oblicz średnią stawkę
                                let avgSalary = rows.data().pluck(5)
                                    .map(function(val) { return parseFloat(String(val).replace(' PLN','')) || 0; })
                                    .average();
                                return $('<tr/>').append('<td colspan="4" style="background-color: #d1ecf1; color: #0c5460; font-weight: bold;">' +
                                    group + ' (Osób: ' + rows.count() + ') | Średnia: ' + avgSalary.toFixed(2) + ' PLN</td>');
                            }
                        }
                    });

                } catch(e) { console.error("Błąd salaryOverviewTable:", e); }
            }

            // ============================================================
            // 4. TABELA KSIĘGOWEGO (All Work Hours)
            // ============================================================
            if ($('#WorkHoursTable').length > 0) {
                (function() {
                    let tableId = 'WorkHoursTable';
                    let settings = getSettings("Szukaj w historii:");
                    settings.paging = false;
                    settings.dom = 'Bfrt';
                    settings.columnDefs = [ { "visible": false, "targets": 0 }, { "orderable": false, "targets": -1 } ];
                    settings.order = [[3, 'desc']];

                    settings.rowGroup = {
                        dataSrc: 0,
                        startRender: function (rows, group) {
                            return $('<tr/>').append('<td colspan="11" style="background-color: #e0e0e0; font-weight: bold;">Tydzień: ' + group + ' (' + rows.count() + ' wpisów)</td>');
                        }
                    };

                    let table = $('#' + tableId).DataTable(settings);
                    let rawData = table.column(0).data().toArray();
                    let uniqueGroups = [];
                    $.each(rawData, function(i, val){
                        let textVal = val ? String(val).replace(/<[^>]+>/g, '').trim() : "";
                        if(textVal && $.inArray(textVal, uniqueGroups) === -1) uniqueGroups.push(textVal);
                    });

                    if(uniqueGroups.length > 0) {
                        let currentIndex = 0;
                        let showAll = false;
                        let navHtml = `
                            <div class="group-pagination">
                                <button id="btn-prev-all" class="group-btn" type="button">&laquo; Starsze</button>
                                <span id="display-all" class="group-info">Ładowanie...</span>
                                <button id="btn-next-all" class="group-btn" type="button">Nowsze &raquo;</button>
                                <button id="btn-all-all" class="group-btn secondary" type="button">Pokaż wszystko</button>
                            </div>`;
                        $('#' + tableId + '_wrapper').prepend(navHtml);

                        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                            if (settings.nTable.id !== tableId) return true;
                            if (showAll) return true;
                            let rowVal = data[0] ? String(data[0]).replace(/<[^>]+>/g, '').trim() : "";
                            return rowVal === uniqueGroups[currentIndex];
                        });

                        function updateView() {
                            if (showAll) {
                                $('#display-all').text("Wszystkie tygodnie (" + uniqueGroups.length + ")");
                                $('#btn-prev-all, #btn-next-all').prop('disabled', true);
                                $('#btn-all-all').text("Pokaż jeden tydzień");
                            } else {
                                $('#display-all').text(uniqueGroups[currentIndex]);
                                $('#btn-prev-all').prop('disabled', currentIndex >= uniqueGroups.length - 1);
                                $('#btn-next-all').prop('disabled', currentIndex <= 0);
                                $('#btn-all-all').text("Pokaż wszystko");
                            }
                            table.draw();
                        }
                        $(document).on('click', '#btn-all-all', function() { showAll = !showAll; updateView(); });
                        $(document).on('click', '#btn-prev-all', function() { if (!showAll && currentIndex < uniqueGroups.length - 1) { currentIndex++; updateView(); } });
                        $(document).on('click', '#btn-next-all', function() { if (!showAll && currentIndex > 0) { currentIndex--; updateView(); } });
                        updateView();
                    }
                })();
            }

            // ============================================================
            // 5. INNE TABELE
            // ============================================================
            var usersTable = $('#myUsersTable').DataTable(commonSettings);
            $('#statusFilter').on('change', function() { usersTable.column(6).search($(this).val()).draw(); });

            $('#projectsTable').DataTable(getSettings("Szukaj projektu:"));
            $('#workTypesTable').DataTable(getSettings("Szukaj typu pracy:"));
            $('#myDepartmentsTable').DataTable(getSettings("Szukaj działu:"));
            $('#myPositionsTable').DataTable(getSettings("Szukaj stanowiska:"));
            $('#myRolesTable').DataTable(getSettings("Szukaj roli:"));
            $('#approvalsTable').DataTable(getSettings("Szukaj pracownika:"));
            $('#PaymentTypesTable').DataTable(getSettings("Szukaj typu wypłaty:"));
            $('#PaymentStatusesTable').DataTable(getSettings("Szukaj statusu wypłaty:"));
            $('#SalaryChangeHistoryTable').DataTable(getSettings("Szukaj w historii zmian:"));
            $('#AllPaymentsTable').DataTable(getSettings("Szukaj w historii wypłat:"));
            $('#mySalaryTable').DataTable(getSettings("Szukaj w historii wypłat:"));
            $('#MyPaymentsTable').DataTable(getSettings("Szukaj w historii wypłat:"));

            $('#statsTable').DataTable({
                "paging": false, "searching": false, "ordering": false,
                "info": false, "dom": 't', "language": { "emptyTable": "Brak danych" }
            });

            $('.dt-project-users').DataTable({ "dom": 'ftp', "pageLength": 5, "language": commonSettings.language, "width": "100%" });
            $('.dt-current-members').DataTable({ "paging": false, "searching": false, "info": false, "dom": 't', "language": { "emptyTable": "Brak członków" }, "width": "100%" });
            $('.dt-approvals').DataTable({ "dom": 'tp', "pageLength": 10, "language": { "emptyTable": "Brak godzin", "paginate": { "first": "<<", "previous": "<", "next": ">", "last": ">>" } }, "width": "100%" });

            $('.tablinks').on('click', function() {
                setTimeout(function() {
                    $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
                }, 100);
            });
        });
    </script>
</div>